<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Organizador de Grupos de Vida</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Google Fonts - Inter (similar a Webflow) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #fafafa;
            color: #1a1a1a;
            line-height: 1.6;
            font-weight: 400;
        }
        
        /* Header minimalista */
        .header {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a1a;
            letter-spacing: -0.02em;
        }
        
        .user-menu {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .user-menu span {
            color: #6b7280;
            font-size: 15px;
            font-weight: 500;
        }
        
        .user-menu a {
            color: #6b7280;
            text-decoration: none;
            font-size: 15px;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .user-menu a:hover {
            background: #f9fafb;
            color: #1a1a1a;
        }
        
        .logout {
            color: #e74c3c !important;
        }
        
        .logout:hover {
            background: #fdf2f2 !important;
        }
        
        /* Container principal */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px;
        }
        
        /* Alertas minimalistas */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            font-size: 14px;
            border: none;
        }
        
        .alert-success {
            background: #f0f9ff;
            color: #0369a1;
        }
        
        .alert-error {
            background: #fef2f2;
            color: #dc2626;
        }
        
        /* Secci√≥n agregar lista */
        .add-list {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
        }
        
        .add-list form {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .add-list input {
            flex: 1;
            padding: 14px 18px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 400;
            background: #ffffff;
            transition: all 0.2s ease;
        }
        
        .add-list input:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .add-list input::placeholder {
            color: #9ca3af;
            font-weight: 400;
        }
        
        .add-list button {
            padding: 14px 28px;
            background: #1a1a1a;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: -0.01em;
        }
        
        .add-list button:hover {
            background: #0f0f0f;
            transform: translateY(-1px);
        }
        
        /* Grid de listas */
        .lists-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 48px;
        }
        
        /* Lista individual */
        .list-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            transition: box-shadow 0.2s;
        }
        
        .list-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .list-header {
            padding: 20px 24px 16px;
            background: #2d3748;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .list-title {
            font-size: 18px;
            font-weight: 700;
            color: white;
            letter-spacing: -0.02em;
        }
        
        .list-count {
            font-size: 13px;
            color: #e2e8f0;
            background: rgba(255, 255, 255, 0.15);
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .list-actions {
            display: flex;
            gap: 8px;
        }
        
        .list-actions a {
            color: #e2e8f0;
            text-decoration: none;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .list-actions a:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }
        
        /* Tarjetas */
        .cards-container {
            padding: 0 24px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .card {
            padding: 16px;
            border-bottom: 1px solid #f5f5f5;
            cursor: move;
            transition: background 0.2s;
        }
        
        .card:last-child {
            border-bottom: none;
        }
        
        .card:hover {
            background: #fafafa;
        }
        
        .card.dragging {
            opacity: 0.5;
        }
        
        .card-name {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 6px;
            letter-spacing: -0.01em;
        }
        
        .card-details {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.5;
            font-weight: 400;
        }
        
        .card-actions {
            margin-top: 8px;
            display: flex;
            gap: 12px;
        }
        
        .card-actions a {
            font-size: 11px;
            color: #666;
            text-decoration: none;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .card-actions a:hover {
            background: #f0f0f0;
            color: #333;
        }
        
        .drag-handle {
            float: right;
            color: #ccc;
            font-size: 14px;
            cursor: move;
        }
        
        .drag-handle:hover {
            color: #999;
        }
        
        /* Formulario agregar persona */
        .add-person {
            padding: 24px;
            border-top: 1px solid #f0f0f0;
            background: #fafafa;
        }
        
        .add-person form {
            display: grid;
            gap: 12px;
        }
        
        .add-person input,
        .add-person select {
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            background: white;
        }
        
        .add-person input:focus,
        .add-person select:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .add-person button {
            padding: 12px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .add-person button:hover {
            background: #059669;
        }
        
        .delete-list {
            text-align: center;
            padding: 16px 24px;
            border-top: 1px solid #f0f0f0;
        }
        
        .delete-list a {
            font-size: 12px;
            color: #ef4444;
            text-decoration: none;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .delete-list a:hover {
            background: #fef2f2;
        }
        
        /* Mapa minimalista */
        .map-section {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 32px;
        }
        
        .map-header {
            padding: 24px 24px 0;
        }
        
        .map-title {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 20px;
            letter-spacing: -0.02em;
        }
        
        .map-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #666;
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #map {
            height: 400px;
            border-radius: 0;
        }
        
        /* Estad√≠sticas minimalistas */
        .stats-section {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 32px;
        }
        
        .stats-title {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 28px;
            letter-spacing: -0.02em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
        }
        
        .stat-item {
            text-align: center;
            padding: 24px;
            background: #fafafa;
            border-radius: 8px;
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: 800;
            color: #1a1a1a;
            margin-bottom: 8px;
            letter-spacing: -0.03em;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
            letter-spacing: -0.01em;
        }
        
        /* Drag and drop estados */
        .list-card.drag-over {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        .drop-indicator {
            height: 2px;
            background: #3b82f6;
            margin: 8px 16px;
            border-radius: 1px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .drop-indicator.active {
            opacity: 1;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 16px 20px;
                flex-direction: column;
                gap: 16px;
            }
            
            .container {
                padding: 20px;
            }
            
            .lists-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .add-list form {
                flex-direction: column;
            }
            
            .add-list input {
                margin-bottom: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Header minimalista -->
    <div class="header">
        <h1>Organizador de Grupos de Vida</h1>
        <div class="user-menu">
            <span>{{ usuario.nombre_completo or usuario.username }}</span>
            <a href="{{ url_for('profile') }}">Perfil</a>
            <a href="{{ url_for('logout') }}" class="logout">Salir</a>
        </div>
    </div>

    <div class="container">
        <!-- Mensajes -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'error' if category == 'error' else 'success' }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Agregar nueva lista -->
        <div class="add-list">
            <form action="/agregar_lista" method="post">
                <input type="text" name="nombre" placeholder="Nueva lista..." required>
                <button type="submit">Agregar Lista</button>
            </form>
        </div>

        <!-- Secci√≥n de exportaci√≥n -->
        <div class="export-section" style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 24px; margin-bottom: 32px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div>
                    <h3 style="font-size: 18px; font-weight: 700; color: #1a1a1a; margin: 0; letter-spacing: -0.02em;">üì• Exportar Datos</h3>
                    <p style="font-size: 14px; color: #6b7280; margin: 4px 0 0 0;">Descarga toda tu informaci√≥n en diferentes formatos</p>
                </div>
            </div>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <a href="{{ url_for('descargar_datos', formato='csv') }}" 
                   style="padding: 10px 20px; background: #059669; color: white; text-decoration: none; border-radius: 8px; font-size: 14px; font-weight: 600; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;">
                    üìä CSV
                </a>
                <a href="{{ url_for('descargar_datos', formato='excel') }}" 
                   style="padding: 10px 20px; background: #0369a1; color: white; text-decoration: none; border-radius: 8px; font-size: 14px; font-weight: 600; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;">
                    üìà Excel
                </a>
                <a href="{{ url_for('descargar_datos', formato='json') }}" 
                   style="padding: 10px 20px; background: #7c3aed; color: white; text-decoration: none; border-radius: 8px; font-size: 14px; font-weight: 600; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;">
                    üîß JSON
                </a>
            </div>
        </div>

        <!-- Grid de listas -->
        <div class="lists-grid">
            {% for lista in listas %}
            <div class="list-card" data-lista-idx="{{ lista.id }}">
                <!-- Header de la lista -->
                <div class="list-header">
                    <div>
                        <div class="list-title">{{ lista.nombre }}</div>
                        <div class="list-count">{{ lista.tarjetas|length }} personas</div>
                    </div>
                    <div class="list-actions">
                        <a href="{{ url_for('editar_lista', lista_id=lista.id) }}">Editar</a>
                        <a href="/eliminar/lista/{{ lista.id }}" 
                           onclick="return confirm('¬øEliminar esta lista?')">Eliminar</a>
                    </div>
                </div>

                <!-- Tarjetas -->
                <div class="cards-container tarjetas-container">
                    {% for tarjeta in lista.tarjetas %}
                    <div class="card" draggable="true" 
                         data-lista-idx="{{ tarjeta.__lista_idx__ }}" 
                         data-tarjeta-idx="{{ tarjeta.__tarjeta_idx__ }}">
                        <span class="drag-handle">‚ãÆ‚ãÆ</span>
                        <div class="card-name">{{ tarjeta.nombre }}</div>
                        <div class="card-details">
                            üìç {{ tarjeta.direccion[:50] }}{% if tarjeta.direccion|length > 50 %}...{% endif %}<br>
                            {% if tarjeta.telefono %}üìû {{ tarjeta.telefono }} ‚Ä¢ {% endif %}
                            {% if tarjeta.edad %}{{ tarjeta.edad }} a√±os{% endif %}
                            {% if tarjeta.estado_civil %} ‚Ä¢ {{ tarjeta.estado_civil }}{% endif %}
                            {% if tarjeta.num_hijos > 0 %}<br>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ {{ tarjeta.num_hijos }} hijos{% endif %}
                        </div>
                        <div class="card-actions">
                            <a href="{{ url_for('editar_tarjeta', lista_id=tarjeta.__lista_idx__, tarjeta_id=tarjeta.__tarjeta_idx__) }}">Editar</a>
                            <a href="{{ url_for('eliminar_tarjeta', lista_id=tarjeta.__lista_idx__, tarjeta_id=tarjeta.__tarjeta_idx__) }}" 
                               onclick="return confirm('¬øEliminar esta persona?')">Eliminar</a>
                        </div>
                    </div>
                    {% endfor %}
                    <div class="drop-indicator"></div>
                </div>
                
                <!-- Formulario agregar persona -->
                <div class="add-person">
                    <form action="/agregar_tarjeta/{{ lista.id }}" method="post">
                        <input type="text" name="nombre" placeholder="Nombre completo" required>
                        <input type="text" name="direccion" placeholder="Direcci√≥n" required>
                        <input type="tel" name="telefono" placeholder="Tel√©fono">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <input type="number" name="edad" placeholder="Edad" min="0" max="120">
                            <input type="number" name="num_hijos" placeholder="N¬∫ hijos" min="0" max="20" value="0">
                        </div>
                        <select name="estado_civil">
                            <option value="">Estado civil</option>
                            <option value="Soltero">Soltero</option>
                            <option value="Casado">Casado</option>
                            <option value="Divorciado">Divorciado</option>
                            <option value="Viudo">Viudo</option>
                            <option value="Uni√≥n libre">Uni√≥n libre</option>
                        </select>
                        <input type="text" name="edades_hijos" placeholder="Edades hijos: 5,8,12">
                        <button type="submit">Agregar Persona</button>
                    </form>
                </div>

                <!-- Eliminar lista -->
                <div class="delete-list">
                    <a href="/eliminar/lista/{{ lista.id }}" 
                       onclick="return confirm('¬øEliminar esta lista y todas las personas?')">
                        Eliminar Lista
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Mapa -->
        <div class="map-section">
            <div class="map-header">
                <h2 class="map-title">Ubicaciones</h2>
                
                <!-- Leyenda minimalista -->
                <div class="map-legend">
                    {% for lista in listas %}
                        {% set color_index = loop.index0 %}
                        {% set colors = ['#FF5722', '#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#607D8B', '#795548', '#E91E63', '#009688', '#FFC107', '#8BC34A', '#3F51B5', '#F44336', '#00BCD4', '#CDDC39'] %}
                        {% set list_color = colors[color_index % colors|length] %}
                        <div class="legend-item">
                            <div class="legend-dot" style="background: {{ list_color }};"></div>
                            <span>{{ lista.nombre }} ({{ lista.tarjetas|length }})</span>
                        </div>
                    {% endfor %}
                </div>
            </div>
            
            <div id="map"></div>
        </div>

        <!-- Estad√≠sticas -->
        <div class="stats-section">
            <h2 class="stats-title">Resumen</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number">{{ listas|length }}</div>
                    <div class="stat-label">Listas</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">
                        {% set total_tarjetas = [] %}
                        {% for lista in listas %}
                            {% for tarjeta in lista.tarjetas %}
                                {% set _ = total_tarjetas.append(1) %}
                            {% endfor %}
                        {% endfor %}
                        {{ total_tarjetas|length }}
                    </div>
                    <div class="stat-label">Personas</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">
                        {% set con_direccion = [] %}
                        {% for lista in listas %}
                            {% for tarjeta in lista.tarjetas %}
                                {% if tarjeta.direccion %}
                                    {% set _ = con_direccion.append(1) %}
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                        {{ con_direccion|length }}
                    </div>
                    <div class="stat-label">En Mapa</div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript (igual que antes) -->
    <script>
        let draggedElement = null;
        let draggedData = null;

        function initDragAndDrop() {
            const tarjetas = document.querySelectorAll('.card');
            const listas = document.querySelectorAll('.list-card');

            tarjetas.forEach(tarjeta => {
                tarjeta.addEventListener('dragstart', handleDragStart);
                tarjeta.addEventListener('dragend', handleDragEnd);
            });

            listas.forEach(lista => {
                const container = lista.querySelector('.tarjetas-container');
                if (container) {
                    container.addEventListener('dragover', handleDragOver);
                    container.addEventListener('drop', handleDrop);
                    container.addEventListener('dragenter', handleDragEnter);
                    container.addEventListener('dragleave', handleDragLeave);
                }
            });
        }

        function handleDragStart(e) {
            draggedElement = this;
            const listaIdx = this.getAttribute('data-lista-idx');
            const tarjetaIdx = this.getAttribute('data-tarjeta-idx');
            
            if (listaIdx === null || tarjetaIdx === null) {
                e.preventDefault();
                return;
            }
            
            draggedData = {
                origen_lista: parseInt(listaIdx),
                origen_tarjeta: parseInt(tarjetaIdx)
            };
            
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            
            document.querySelectorAll('.list-card').forEach(lista => {
                lista.classList.remove('drag-over');
            });
            document.querySelectorAll('.drop-indicator').forEach(indicator => {
                indicator.classList.remove('active');
            });
            
            draggedElement = null;
            draggedData = null;
        }

        function handleDragEnter(e) {
            e.preventDefault();
            const lista = e.currentTarget.closest('.list-card');
            if (lista) lista.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            const lista = e.currentTarget.closest('.list-card');
            if (lista && !lista.contains(e.relatedTarget)) {
                lista.classList.remove('drag-over');
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            const container = e.currentTarget;
            const cards = [...container.querySelectorAll('.card:not(.dragging)')];
            const dropIndicators = [...container.querySelectorAll('.drop-indicator')];
            
            dropIndicators.forEach(indicator => indicator.classList.remove('active'));
            
            const afterElement = getDragAfterElement(container, e.clientY);
            const indicator = afterElement ? 
                afterElement.previousElementSibling : 
                container.querySelector('.drop-indicator:last-child');
            
            if (indicator && indicator.classList.contains('drop-indicator')) {
                indicator.classList.add('active');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            
            if (!draggedElement || !draggedData) return;
            
            const lista = e.currentTarget.closest('.list-card');
            const destinoListaIdxAttr = lista.getAttribute('data-lista-idx');
            
            if (destinoListaIdxAttr === null) return;
            
            const destinoListaIdx = parseInt(destinoListaIdxAttr);
            const container = e.currentTarget;
            
            const afterElement = getDragAfterElement(container, e.clientY);
            let destinoPosicion = 0;
            
            if (afterElement) {
                const cards = [...container.querySelectorAll('.card:not(.dragging)')];
                destinoPosicion = cards.indexOf(afterElement);
            } else {
                destinoPosicion = container.querySelectorAll('.card:not(.dragging)').length;
            }
            
            if (draggedData.origen_lista === destinoListaIdx && 
                draggedData.origen_tarjeta < destinoPosicion) {
                destinoPosicion--;
            }
            
            moverTarjeta(draggedData.origen_lista, draggedData.origen_tarjeta, 
                       destinoListaIdx, destinoPosicion);
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.card:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function moverTarjeta(origenLista, origenTarjeta, destinoLista, destinoPosicion) {
            fetch('/mover_tarjeta', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    origen_lista: origenLista,
                    origen_tarjeta: origenTarjeta,
                    destino_lista: destinoLista,
                    destino_posicion: destinoPosicion
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Error al mover la persona');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al mover la persona');
            });
        }

        document.addEventListener('DOMContentLoaded', initDragAndDrop);
    </script>

    <!-- Google Maps JavaScript API -->
    
    
    <script>
        let map;
        let geocoder;
        let infoWindow;
        let markers = [];

        
    <!-- Autocompletado de Direcciones -->
    <script>
        // Variables globales para autocompletado
        let autocompleteInstances = [];

        // Funci√≥n para inicializar autocompletado en un campo espec√≠fico
        function initAutocompleteForField(inputElement, options = {}) {
            if (!inputElement) return null;
            
            // Configuraci√≥n por defecto para Florida
            const defaultOptions = {
                types: ['address'],
                componentRestrictions: { country: 'us' },
                bounds: new google.maps.LatLngBounds(
                    new google.maps.LatLng(24.3963, -87.6349), // Southwest (Florida Keys)
                    new google.maps.LatLng(31.0009, -79.8742)  // Northeast (Georgia border)
                ),
                strictBounds: false,
                fields: ['formatted_address', 'geometry', 'address_components', 'place_id']
            };
            
            const finalOptions = { ...defaultOptions, ...options };
            
            try {
                const autocomplete = new google.maps.places.Autocomplete(inputElement, finalOptions);
                
                // Agregar listener para cuando se selecciona una direcci√≥n
                autocomplete.addListener('place_changed', function() {
                    const place = autocomplete.getPlace();
                    
                    if (!place.geometry) {
                        console.log("No se encontraron detalles para: '" + place.name + "'");
                        return;
                    }
                    
                    // Actualizar el campo con la direcci√≥n formateada
                    if (place.formatted_address) {
                        inputElement.value = place.formatted_address;
                    }
                    
                    console.log('Direcci√≥n seleccionada:', place.formatted_address);
                });
                
                autocompleteInstances.push(autocomplete);
                return autocomplete;
                
            } catch (error) {
                console.error('Error inicializando autocompletado:', error);
                return null;
            }
        }

        // Funci√≥n para inicializar todos los campos de direcci√≥n
        function initAllAutocomplete() {
            const addressFields = document.querySelectorAll('input[name="direccion"]');
            
            addressFields.forEach(field => {
                if (!field.classList.contains('autocomplete-enabled')) {
                    field.classList.add('autocomplete-enabled');
                    field.placeholder = "üîç Comienza a escribir una direcci√≥n...";
                    initAutocompleteForField(field);
                }
            });
            
            console.log(`‚úÖ Autocompletado inicializado en ${addressFields.length} campos`);
        }

        // CSS para mejorar la apariencia
        const autocompleteStyle = document.createElement('style');
        autocompleteStyle.textContent = `
            .pac-container {
                border-radius: 8px !important;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15) !important;
                border: none !important;
                margin-top: 2px !important;
                font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
                z-index: 9999 !important;
            }
            
            .pac-item {
                padding: 12px 16px !important;
                border-bottom: 1px solid #f0f0f0 !important;
                cursor: pointer !important;
                transition: background-color 0.2s !important;
            }
            
            .pac-item:hover,
            .pac-item-selected {
                background-color: #f8f9fa !important;
            }
            
            .pac-matched {
                font-weight: 600 !important;
                color: #1976d2 !important;
            }
            
            .pac-item-query {
                font-size: 14px !important;
                color: #333 !important;
            }
            
            .pac-secondary-text {
                font-size: 12px !important;
                color: #666 !important;
            }
            
            input[name="direccion"] {
                background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>') !important;
                background-repeat: no-repeat !important;
                background-position: right 10px center !important;
                background-size: 16px 16px !important;
            }
        `;
        document.head.appendChild(autocompleteStyle);
    </script>
    
    </script>

    <!-- Google Maps API -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAM44jyxplaDzn1m7bJ79RtQGCmzYNuOCg&callback=initMap&libraries=geometry,places"></script>
    
    <script>
        let map;
        let geocoder;
        let infoWindow;
        let markers = [];

        function initMap() {
            console.log('üó∫Ô∏è Inicializando mapa...');
            
            const windermere = { lat: 28.4159, lng: -81.4412 };
            
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: windermere,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                styles: [
                    { featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] },
                    { featureType: "transit", elementType: "labels", stylers: [{ visibility: "off" }] }
                ]
            });

            geocoder = new google.maps.Geocoder();
            infoWindow = new google.maps.InfoWindow();

            // Inicializar autocompletado despu√©s del mapa
            setTimeout(() => {
                initAutocomplete();
            }, 500);

            addAllMarkers();
        }

        function initAutocomplete() {
            try {
                const addressFields = document.querySelectorAll('input[name="direccion"]');
                
                addressFields.forEach(field => {
                    if (!field.dataset.autocompleteEnabled) {
                        const autocomplete = new google.maps.places.Autocomplete(field, {
                            types: ['address'],
                            componentRestrictions: { country: 'us' },
                            bounds: new google.maps.LatLngBounds(
                                new google.maps.LatLng(24.3963, -87.6349),
                                new google.maps.LatLng(31.0009, -79.8742)
                            ),
                            strictBounds: false
                        });
                        
                        autocomplete.addListener('place_changed', function() {
                            const place = autocomplete.getPlace();
                            if (place.formatted_address) {
                                field.value = place.formatted_address;
                            }
                        });
                        
                        field.placeholder = "üîç Comienza a escribir una direcci√≥n...";
                        field.dataset.autocompleteEnabled = "true";
                    }
                });
                
                console.log('‚úÖ Autocompletado inicializado');
                
            } catch (error) {
                console.log('‚ö†Ô∏è Error en autocompletado:', error);
            }
        }

        function addAllMarkers() {
            const addresses = [];
            const availableColors = [
                '#FF5722', '#4CAF50', '#2196F3', '#FF9800', '#9C27B0', 
                '#607D8B', '#795548', '#E91E63', '#009688', '#FFC107', 
                '#8BC34A', '#3F51B5', '#F44336', '#00BCD4', '#CDDC39'
            ];
            
            const listColors = {};
            const listNames = [
                {% for lista in listas %}"{{ lista.nombre }}"{% if not loop.last %},{% endif %}{% endfor %}
            ];
            
            listNames.forEach((listName, index) => {
                listColors[listName] = availableColors[index % availableColors.length];
            });
            
            {% for lista in listas %}
                {% for tarjeta in lista.tarjetas %}
                    {% if tarjeta.direccion %}
                        addresses.push({
                            address: "{{ tarjeta.direccion }}",
                            name: "{{ tarjeta.nombre }}",
                            phone: "{{ tarjeta.telefono }}",
                            age: "{{ tarjeta.edad }}",
                            maritalStatus: "{{ tarjeta.estado_civil }}",
                            children: {{ tarjeta.num_hijos }},
                            childrenAges: {{ tarjeta.edades_hijos | tojson }},
                            listName: "{{ lista.nombre }}",
                            listColor: listColors["{{ lista.nombre }}"]
                        });
                    {% endif %}
                {% endfor %}
            {% endfor %}

            addresses.forEach((item, index) => {
                setTimeout(() => {
                    geocodeAddress(item);
                }, index * 300);
            });
        }

        function geocodeAddress(addressData) {
            geocoder.geocode({ address: addressData.address }, (results, status) => {
                if (status === "OK" && results[0]) {
                    const position = results[0].geometry.location;
                    
                    let infoContent = `
                        <div style="max-width: 280px; font-family: 'Inter', sans-serif;">
                            <h3 style="margin: 0 0 15px 0; color: ${addressData.listColor}; border-bottom: 2px solid ${addressData.listColor}; padding-bottom: 8px; font-weight: 600;">
                                üôè ${addressData.name}
                            </h3>
                            <p style="margin: 8px 0; padding: 6px 12px; background: ${addressData.listColor}20; border-radius: 20px; color: #333; font-weight: 500; font-size: 13px;">
                                üìã ${addressData.listName}
                            </p>
                            <p style="margin: 8px 0; color: #666; font-size: 14px;"><strong>üìç Direcci√≥n:</strong><br>${addressData.address}</p>
                    `;
                    
                    if (addressData.phone) {
                        infoContent += `<p style="margin: 8px 0; color: #666; font-size: 14px;"><strong>üìû Tel√©fono:</strong> ${addressData.phone}</p>`;
                    }
                    
                    if (addressData.age) {
                        infoContent += `<p style="margin: 8px 0; color: #666; font-size: 14px;"><strong>üéÇ Edad:</strong> ${addressData.age} a√±os</p>`;
                    }
                    
                    if (addressData.maritalStatus) {
                        infoContent += `<p style="margin: 8px 0; color: #666; font-size: 14px;"><strong>üíë Estado Civil:</strong> ${addressData.maritalStatus}</p>`;
                    }
                    
                    if (addressData.children > 0) {
                        infoContent += `<p style="margin: 8px 0; color: #666; font-size: 14px;"><strong>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Hijos:</strong> ${addressData.children}`;
                        if (addressData.childrenAges && addressData.childrenAges.length > 0) {
                            infoContent += ` (${addressData.childrenAges.join(', ')} a√±os)`;
                        }
                        infoContent += `</p>`;
                    }
                    
                    infoContent += `
                        <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; text-align: center;">
                            <small style="color: #999; font-size: 12px;">üí° Tip: Usa esta informaci√≥n para planificar visitas</small>
                        </div>
                    </div>`;

                    const marker = new google.maps.Marker({
                        position: position,
                        map: map,
                        title: `${addressData.name} - ${addressData.listName}`,
                        animation: google.maps.Animation.DROP,
                        icon: {
                            url: `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`
                                <svg xmlns='http://www.w3.org/2000/svg' width='32' height='45' viewBox='0 0 32 45'>
                                    <path d='M16 0C7.2 0 0 7.2 0 16c0 16 16 29 16 29s16-13 16-29C32 7.2 24.8 0 16 0z' fill='${addressData.listColor}' stroke='white' stroke-width='2'/>
                                    <circle cx='16' cy='16' r='8' fill='white'/>
                                    <text x='16' y='21' font-family='Arial' font-size='14' fill='${addressData.listColor}' text-anchor='middle' font-weight='bold'>üôè</text>
                                </svg>
                            `)}`,
                            scaledSize: new google.maps.Size(32, 45),
                            anchor: new google.maps.Point(16, 45)
                        }
                    });

                    marker.addListener("click", () => {
                        infoWindow.setContent(infoContent);
                        infoWindow.open(map, marker);
                    });

                    markers.push(marker);

                    if (markers.length === 1) {
                        map.setCenter(position);
                        map.setZoom(14);
                    }
                    
                    if (markers.length > 1) {
                        adjustMapToShowAllMarkers();
                    }
                } else {
                    console.log("Geocoding fall√≥ para: " + addressData.address + " - " + status);
                }
            });
        }

        function adjustMapToShowAllMarkers() {
            if (markers.length > 1) {
                const bounds = new google.maps.LatLngBounds();
                markers.forEach(marker => {
                    bounds.extend(marker.getPosition());
                });
                map.fitBounds(bounds);
                
                google.maps.event.addListenerOnce(map, 'bounds_changed', function() {
                    if (map.getZoom() > 15) {
                        map.setZoom(15);
                    }
                });
            }
        }

        // CSS para autocompletado
        const style = document.createElement('style');
        style.textContent = `
            .pac-container {
                border-radius: 8px !important;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15) !important;
                border: none !important;
                margin-top: 2px !important;
                font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
                z-index: 9999 !important;
            }
            
            .pac-item {
                padding: 12px 16px !important;
                border-bottom: 1px solid #f0f0f0 !important;
                cursor: pointer !important;
                transition: background-color 0.2s !important;
            }
            
            .pac-item:hover, .pac-item-selected {
                background-color: #f8f9fa !important;
            }
            
            .pac-matched {
                font-weight: 600 !important;
                color: #1976d2 !important;
            }
            
            input[name="direccion"] {
                background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>') !important;
                background-repeat: no-repeat !important;
                background-position: right 10px center !important;
                background-size: 16px 16px !important;
            }
        `;
        document.head.appendChild(style);
    </script>

</body>
</html>